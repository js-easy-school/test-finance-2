<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Котировки топ-100 акций MOEX</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
    <style>
      :root {
        --moex-blue: #0039a6;
        --moex-red: #d52b1e;
        --moex-gray: #f4f6f9;
        --moex-dark: #333333;
      }

      body {
        font-family: "Arial", sans-serif;
        margin: 0;
        padding: 20px;
        background: var(--moex-gray);
        color: var(--moex-dark);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      header {
        text-align: center;
        margin-bottom: 25px;
        border-bottom: 2px solid var(--moex-blue);
        padding-bottom: 15px;
      }

      h1 {
        color: var(--moex-blue);
        margin: 0;
        font-size: 2.2rem;
      }

      .description {
        color: #666;
        font-size: 1.1rem;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      label {
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--moex-blue);
      }

      select,
      input,
      button {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
      }

      select {
        height: 46px;
        background: white;
      }

      button {
        background: var(--moex-blue);
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
        font-weight: bold;
      }

      button:hover {
        background: #002d80;
      }

      .chart-container {
        position: relative;
        height: 600px;
        margin-bottom: 30px;
      }

      .companies {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 30px;
      }

      .company-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
      }

      .company-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .company-name {
        font-weight: bold;
        color: var(--moex-blue);
      }

      .company-ticker {
        font-size: 0.9rem;
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 40px;
        font-size: 1.2rem;
        color: #666;
      }

      .error {
        color: var(--moex-red);
        text-align: center;
        padding: 20px;
        background: #ffebee;
        border-radius: 8px;
        margin: 20px 0;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        color: #666;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .controls {
          grid-template-columns: 1fr;
        }

        .chart-container {
          height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Котировки топ-100 российских акций</h1>
        <p class="description">
          Исторические данные за 10 лет с Московской биржи (MOEX)
        </p>
      </header>

      <div class="controls">
        <div class="control-group">
          <label for="tickers">Выберите акции:</label>
          <select id="tickers" multiple size="5">
            <!-- Options will be populated by JavaScript -->
          </select>
          <small>Для выбора нескольких акций используйте Ctrl+Click</small>
        </div>

        <div class="control-group">
          <label for="from">Дата от:</label>
          <input type="date" id="from" />
        </div>

        <div class="control-group">
          <label for="till">Дата до:</label>
          <input type="date" id="till" />
        </div>

        <div class="control-group">
          <label>&nbsp;</label>
          <button onclick="loadChart()">Загрузить котировки</button>
          <button onclick="clearChart()">Очистить график</button>
        </div>
      </div>

      <div id="error-message" class="error" style="display: none"></div>

      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>

      <div id="loading" class="loading" style="display: none">
        Загрузка данных...
      </div>

      <h2>Топ-100 российских акций</h2>
      <div id="companies-list" class="companies">
        <!-- Company cards will be populated by JavaScript -->
      </div>

      <footer>
        <p>Данные предоставлены Московской биржей (MOEX ISS API)</p>
        <p>Информация представлена исключительно в ознакомительных целях</p>
      </footer>
    </div>

    <script>
      // Топ-100 российских акций по данным Московской биржи
      const top100Stocks = [
        { ticker: "SBER", name: "Сбербанк", sector: "Финансы" },
        { ticker: "GAZP", name: "Газпром", sector: "Нефть и газ" },
        { ticker: "ROSN", name: "Роснефть", sector: "Нефть и газ" },
        { ticker: "NVTK", name: "Новатэк", sector: "Нефть и газ" },
        { ticker: "GMKN", name: "Норильский никель", sector: "Металлургия" },
        { ticker: "LKOH", name: "Лукойл", sector: "Нефть и газ" },
        { ticker: "SIBN", name: "Газпром нефть", sector: "Нефть и газ" },
        { ticker: "PLZL", name: "Полюс", sector: "Металлургия" },
        {
          ticker: "PHOR",
          name: "ФосАгро",
          sector: "Химическая промышленность",
        },
        { ticker: "SNGS", name: "Сургутнефтегаз", sector: "Нефть и газ" },
        { ticker: "TATN", name: "Татнефть", sector: "Нефть и газ" },
        { ticker: "NLMK", name: "НЛМК", sector: "Металлургия" },
        { ticker: "CHMF", name: "Северсталь", sector: "Металлургия" },
        { ticker: "AKRN", name: "Акрон", sector: "Химическая промышленность" },
        { ticker: "VSMO", name: "ВСМПО-Ависма", sector: "Металлургия" },
        { ticker: "RUAL", name: "Русал", sector: "Металлургия" },
        { ticker: "PIKK", name: "ПИК", sector: "Строительство" },
        {
          ticker: "ALRS",
          name: "АЛРОСА",
          sector: "Добыча полезных ископаемых",
        },
        { ticker: "MTSS", name: "МТС", sector: "Телекоммуникации" },
        { ticker: "MGNT", name: "Магнит", sector: "Ритейл" },
        { ticker: "TCSG", name: "TCS Group", sector: "Финансы" },
        { ticker: "MAGN", name: "ММК", sector: "Металлургия" },
        { ticker: "HYDR", name: "РусГидро", sector: "Электроэнергетика" },
        { ticker: "IRKT", name: "Иркут", sector: "Машиностроение" },
        { ticker: "UNAC", name: "ОАК", sector: "Машиностроение" },
        { ticker: "IRAO", name: "Интер РАО", sector: "Электроэнергетика" },
        { ticker: "VTBR", name: "ВТБ", sector: "Финансы" },
        { ticker: "RTKM", name: "Ростелеком", sector: "Телекоммуникации" },
        {
          ticker: "RASP",
          name: "Распадская",
          sector: "Добыча полезных ископаемых",
        },
        { ticker: "MOEX", name: "Московская биржа", sector: "Финансы" },
        // Остальные акции из топ-100
        { ticker: "AFKS", name: "Система", sector: "Холдинги" },
        { ticker: "AFLT", name: "Аэрофлот", sector: "Транспорт" },
        { ticker: "BANE", name: "Башнефть", sector: "Нефть и газ" },
        { ticker: "CBOM", name: "МКБ", sector: "Финансы" },
        { ticker: "DSKY", name: "Детский мир", sector: "Ритейл" },
        { ticker: "FEES", name: "ФСК ЕЭС", sector: "Электроэнергетика" },
        { ticker: "FIVE", name: "X5 Group", sector: "Ритейл" },
        { ticker: "FLOT", name: "Совкомфлот", sector: "Транспорт" },
        { ticker: "GCHE", name: "Черкизово", sector: "Пищевая промышленность" },
        { ticker: "GLTR", name: "Глобалтранс", sector: "Транспорт" },
        { ticker: "LSRG", name: "ЛСР", sector: "Строительство" },
        { ticker: "MGTSP", name: "МГТС", sector: "Телекоммуникации" },
        { ticker: "MSNG", name: "Мосэнерго", sector: "Электроэнергетика" },
        { ticker: "MTLR", name: "Мечел", sector: "Металлургия" },
        { ticker: "NMTP", name: "НМТП", sector: "Транспорт" },
        { ticker: "NSVZ", name: "Наука-Связь", sector: "Телекоммуникации" },
        { ticker: "OGKB", name: "ОГК-2", sector: "Электроэнергетика" },
        { ticker: "OKEY", name: "О'Кей", sector: "Ритейл" },
        { ticker: "POLY", name: "Polymetal", sector: "Металлургия" },
        { ticker: "PRTK", name: "Протек", sector: "Фармацевтика" },
        { ticker: "QIWI", name: "Киви", sector: "Финансы" },
        { ticker: "RSTI", name: "РСТИ", sector: "Машиностроение" },
        { ticker: "RUGR", name: "Русгрэйн", sector: "Пищевая промышленность" },
        { ticker: "SFIN", name: "СФИН", sector: "Финансы" },
        { ticker: "SMLT", name: "Самолет", sector: "Строительство" },
        { ticker: "TASB", name: "ТАСБ", sector: "Финансы" },
        { ticker: "TGKA", name: "ТГК-1", sector: "Электроэнергетика" },
        { ticker: "TGKB", name: "ТГК-2", sector: "Электроэнергетика" },
        { ticker: "TGKN", name: "ТГК-14", sector: "Электроэнергетика" },
        { ticker: "UPRO", name: "Юнипро", sector: "Электроэнергетика" },
        {
          ticker: "URKA",
          name: "Уралкалий",
          sector: "Химическая промышленность",
        },
        { ticker: "USBN", name: "Уралсиб", sector: "Финансы" },
        { ticker: "VRSB", name: "ТНС энерго", sector: "Электроэнергетика" },
        { ticker: "YNDX", name: "Яндекс", sector: "Интернет" },
        // Дополняем до 100 акций
        { ticker: "ETLN", name: "ЕТЛ", sector: "Транспорт" },
        { ticker: "HHRU", name: "HeadHunter", sector: "Интернет" },
        { ticker: "MDMG", name: "М.Видео", sector: "Ритейл" },
        { ticker: "OBUV", name: "Обувь России", sector: "Ритейл" },
        { ticker: "ODVA", name: "ОДК", sector: "Машиностроение" },
        { ticker: "POSI", name: "Позитив", sector: "Телекоммуникации" },
        { ticker: "RKKE", name: "РКК", sector: "Машиностроение" },
        {
          ticker: "ROLO",
          name: "Русолото",
          sector: "Добыча полезных ископаемых",
        },
        { ticker: "RTKMP", name: "Ростелеком", sector: "Телекоммуникации" },
        { ticker: "RTSB", name: "ТСБ", sector: "Финансы" },
        { ticker: "RU000A0JXNU1", name: "РЖД", sector: "Транспорт" },
        { ticker: "SARE", name: "Саратовнефтегаз", sector: "Нефть и газ" },
        { ticker: "SBERP", name: "Сбербанк-п", sector: "Финансы" },
        {
          ticker: "SELG",
          name: "Селигдар",
          sector: "Добыча полезных ископаемых",
        },
        { ticker: "SGZH", name: "Сегежа", sector: "Лесная промышленность" },
        { ticker: "SIBN", name: "Газпром нефть", sector: "Нефть и газ" },
        { ticker: "SNGSP", name: "Сургутнефтегаз-п", sector: "Нефть и газ" },
        { ticker: "SVAV", name: "Соллерс", sector: "Машиностроение" },
        { ticker: "TASBP", name: "ТАСБ-п", sector: "Финансы" },
        { ticker: "TRMK", name: "ТМК", sector: "Металлургия" },
        { ticker: "TUZA", name: "Туранском", sector: "Электроэнергетика" },
        { ticker: "UCSS", name: "КСС", sector: "Строительство" },
        { ticker: "UNKL", name: "ЮУНК", sector: "Металлургия" },
        { ticker: "VGSB", name: "Волга", sector: "Финансы" },
        { ticker: "VRSBP", name: "ТНС энерго-п", sector: "Электроэнергетика" },
        { ticker: "VSYD", name: "Выборгский", sector: "Судостроение" },
        { ticker: "WTCM", name: "ЦМТ", sector: "Металлургия" },
        { ticker: "YAKG", name: "ЯТЭК", sector: "Нефть и газ" },
        { ticker: "YKEN", name: "Якутскэнерго", sector: "Электроэнергетика" },
        {
          ticker: "YKENP",
          name: "Якутскэнерго-п",
          sector: "Электроэнергетика",
        },
        { ticker: "ZILL", name: "ЗИЛ", sector: "Машиностроение" },
        { ticker: "ZVEZ", name: "ЗВЕЗДА", sector: "Машиностроение" },
      ];

      let chart;
      const cachedData = {};
      const colors = [
        "#0039a6",
        "#d52b1e",
        "#ff9900",
        "#00cc66",
        "#9966cc",
        "#ff6699",
        "#66ccff",
        "#ffcc00",
        "#cc0066",
        "#00cc99",
        "#3366ff",
        "#ff3333",
        "#99cc00",
        "#cc66ff",
        "#ff6600",
        "#00ccff",
        "#cc0000",
        "#00cc00",
        "#cc00cc",
        "#cccc00",
      ];

      // Инициализация страницы
      function initPage() {
        // Заполняем выпадающий список акций
        const tickersSelect = document.getElementById("tickers");
        top100Stocks.forEach((stock) => {
          const option = document.createElement("option");
          option.value = stock.ticker;
          option.textContent = `${stock.ticker} - ${stock.name}`;
          tickersSelect.appendChild(option);
        });

        // Устанавливаем даты по умолчанию (последние 10 лет)
        const till = new Date();
        const from = new Date();
        from.setFullYear(from.getFullYear() - 10);

        document.getElementById("from").value = formatDate(from);
        document.getElementById("till").value = formatDate(till);

        // Заполняем список компаний
        renderCompanyCards();
      }

      // Форматирование даты в YYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Отображение карточек компаний
      function renderCompanyCards() {
        const companiesList = document.getElementById("companies-list");
        companiesList.innerHTML = "";

        top100Stocks.forEach((stock, index) => {
          const card = document.createElement("div");
          card.className = "company-card";
          card.innerHTML = `
          <div class="company-name">${stock.name}</div>
          <div class="company-ticker">${stock.ticker}</div>
          <div class="company-sector">${stock.sector}</div>
        `;
          card.addEventListener("click", () => {
            document.getElementById("tickers").value = stock.ticker;
            loadChart();
          });
          companiesList.appendChild(card);
        });
      }

      // Получение данных с MOEX ISS API
      async function fetchMOEX(ticker, from, till) {
        // Проверяем кэш
        const cacheKey = `${ticker}-${from}-${till}`;
        if (cachedData[cacheKey]) {
          return cachedData[cacheKey];
        }

        const url = `https://iss.moex.com/iss/history/engines/stock/markets/shares/boards/TQBR/securities/${ticker}.json?from=${from}&till=${till}&history.columns=TRADEDATE,CLOSE`;

        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Ошибка запроса к MOEX API");

          const data = await response.json();
          const history = data.history.data.map((row) => ({
            date: row[0],
            close: row[1],
          }));

          // Сохраняем в кэш
          cachedData[cacheKey] = history;
          return history;
        } catch (error) {
          console.error(`Ошибка при загрузке данных для ${ticker}:`, error);
          throw error;
        }
      }

      // Загрузка и отображение графика
      async function loadChart() {
        const selectedOptions =
          document.getElementById("tickers").selectedOptions;
        if (selectedOptions.length === 0) {
          showError("Пожалуйста, выберите хотя бы одну акцию");
          return;
        }

        const from = document.getElementById("from").value;
        const till = document.getElementById("till").value;

        if (!from || !till) {
          showError("Пожалуйста, укажите обе даты");
          return;
        }

        // Показываем индикатор загрузки
        document.getElementById("loading").style.display = "block";
        hideError();

        try {
          const selectedTickers = Array.from(selectedOptions).map(
            (option) => option.value
          );
          const datasets = [];

          // Загружаем данные для каждого выбранного тикера
          for (let i = 0; i < selectedTickers.length; i++) {
            const ticker = selectedTickers[i];
            const candles = await fetchMOEX(ticker, from, till);

            if (candles.length === 0) {
              console.warn(`Нет данных для тикера ${ticker}`);
              continue;
            }

            // Находим информацию об акции
            const stockInfo = top100Stocks.find(
              (stock) => stock.ticker === ticker
            );
            const label = stockInfo ? `${ticker} - ${stockInfo.name}` : ticker;

            datasets.push({
              label: label,
              data: candles.map((c) => ({ x: c.date, y: c.close })),
              borderColor: colors[i % colors.length],
              backgroundColor: colors[i % colors.length] + "20",
              tension: 0.1,
              fill: false,
            });
          }

          if (datasets.length === 0) {
            showError("Не удалось загрузить данные для выбранных акций");
            return;
          }

          // Создаем или обновляем график
          const ctx = document.getElementById("chart").getContext("2d");

          if (chart) {
            chart.destroy();
          }

          chart = new Chart(ctx, {
            type: "line",
            data: {
              datasets: datasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "top",
                  labels: {
                    boxWidth: 15,
                    padding: 20,
                  },
                },
                title: {
                  display: true,
                  text: "Котировки акций на MOEX",
                  font: {
                    size: 18,
                  },
                },
                tooltip: {
                  mode: "index",
                  intersect: false,
                  callbacks: {
                    label: function (context) {
                      return `${
                        context.dataset.label
                      }: ${context.parsed.y.toFixed(2)} RUB`;
                    },
                  },
                },
              },
              scales: {
                x: {
                  type: "time",
                  time: {
                    unit: "year",
                    tooltipFormat: "dd.MM.yyyy",
                  },
                  title: {
                    display: true,
                    text: "Дата",
                  },
                },
                y: {
                  beginAtZero: false,
                  title: {
                    display: true,
                    text: "Цена закрытия (RUB)",
                  },
                  ticks: {
                    callback: function (value) {
                      return value.toFixed(2) + " RUB";
                    },
                  },
                },
              },
              interaction: {
                mode: "nearest",
                axis: "x",
                intersect: false,
              },
            },
          });
        } catch (error) {
          console.error("Ошибка при создании графика:", error);
          showError("Произошла ошибка при загрузке данных: " + error.message);
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      // Очистка графика
      function clearChart() {
        if (chart) {
          chart.destroy();
          chart = null;
        }
        document.getElementById("tickers").selectedIndex = -1;
      }

      // Показать сообщение об ошибке
      function showError(message) {
        const errorElement = document.getElementById("error-message");
        errorElement.textContent = message;
        errorElement.style.display = "block";
      }

      // Скрыть сообщение об ошибке
      function hideError() {
        document.getElementById("error-message").style.display = "none";
      }

      // Инициализация при загрузке страницы
      window.onload = initPage;
    </script>
  </body>
</html>

